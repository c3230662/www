<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>大垣市 神社マップ（管理用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
        "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    header {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #e5e5e5;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.6rem;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    .ctl {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }
    input[type="text"] {
      font-size: 0.9rem;
      padding: 0.38rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
      background: transparent;
    }
    .btn {
      font-size: 0.9rem;
      padding: 0.38rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
      background: transparent;
      cursor: pointer;
    }
    .btn.on {
      background: #16a34a33;
      border-color: #16a34a;
    }
    #map {
      height: calc(100vh - 60px);
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      background: rgba(0, 0, 0, 0.78);
      color: #fff;
      padding: 0.5rem 0.8rem;
      border-radius: 0.5rem;
      font-size: 0.82rem;
      display: none;
      z-index: 1000;
    }
    .popup h3 {
      margin: 0 0 0.3rem;
      font-size: 1rem;
    }
    .popup p {
      margin: 0.25rem 0;
    }
    .desc {
      white-space: pre-wrap;
    }
    .hint {
      font-size: 0.8rem;
      opacity: 0.75;
    }
    .form-row {
      display: grid;
      gap: 0.3rem;
      margin: 0.3rem 0;
    }
    .form-row input,
    .form-row textarea {
      width: 100%;
      font-size: 0.9rem;
      padding: 0.4rem 0.5rem;
      border-radius: 0.45rem;
      border: 1px solid #ccc;
      background: transparent;
    }
    .form-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.3rem;
    }
    .del, .edit {
      text-decoration: underline;
      cursor: pointer;
    }
    .del { color: #b91c1c; }
    .edit { color: #2563eb; }
    /* ポップアップが画面からはみ出さないように */
    .leaflet-popup-content {
      max-height: 240px;
      overflow-y: auto;
    }
    @media (prefers-color-scheme: dark) {
      .form-row input,
      .form-row textarea {
        border-color: #2a2d32;
        color: #e9eaed;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>大垣市 神社マップ（管理用）</h1>
    <div class="ctl">
      <input id="searchKw" type="text" placeholder="神社名 or 住所で検索" />
      <button id="btnSearch" class="btn">検索してジャンプ</button>

      <button id="createToggle"
              class="btn"
              aria-pressed="false"
              title="作成モードON中は地図クリックで追加">
        作成モード OFF
      </button>
    </div>
  </header>

  <div id="map"></div>
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ==== 共通ユーティリティ ====
    const $ = (id) => document.getElementById(id);
    const showToast = (msg, ms = 2200) => {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => (t.style.display = "none"), ms);
    };
    const esc = (s) =>
      String(s ?? "").replace(/[&<>"']/g, (c) =>
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
      );

    const LS_KEY = "ogaki_shrines_v1";
    const saveData = (arr) =>
      localStorage.setItem(LS_KEY, JSON.stringify(arr || []));
    const loadData = () => {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      } catch {
        return [];
      }
    };

    // ==== 地図・状態 ====
    let map, markerLayer;
    let createMode = false;
    let tempMarker = null;
    let currentData = [];
    let currentMarkers = [];

    function initMap() {
      map = L.map("map").setView([35.366, 136.62], 13); // 大垣市付近
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);

      // 作成モード中：クリックした場所に新規ピン
      map.on("click", (e) => {
        if (!createMode) return;
        openEditFormAt(e.latlng, null); // 新規
      });
    }

    function buildPopupHtml(r, idx) {
      const name = esc(r.name || "(名称未設定)");
      const addr = esc(r.address || "");
      const url = esc(r.url || "");
      const desc = esc(r.desc || "");
      const descBlock = desc
        ? '<div class="desc">' + desc + "</div>"
        : '<div class="hint">（説明は未入力）</div>';
      const urlBlock = url
        ? '<p><a href="' +
          url +
          '" target="_blank" rel="noopener">解説ページを開く</a></p>'
        : "";
      return (
        '<div class="popup">' +
        "<h3>" + name + "</h3>" +
        (addr ? "<p>" + addr + "</p>" : "") +
        urlBlock +
        descBlock +
        '<div class="hint">' +
        '<a class="edit" data-idx="' + idx + '">このピンを編集</a> / ' +
        '<a class="del" data-idx="' + idx + '">削除</a>' +
        "</div>" +
        "</div>"
      );
    }

    function renderMarkers() {
      markerLayer.clearLayers();
      currentData = loadData();
      currentMarkers = [];

      currentData.forEach((r, idx) => {
        if (!Number.isFinite(r.lat) || !Number.isFinite(r.lng)) return;
        const m = L.marker([r.lat, r.lng]).addTo(markerLayer);
        m.bindPopup(buildPopupHtml(r, idx), { maxWidth: 360 });

        m.on("popupopen", (ev) => {
          const el = ev.popup.getElement();
          const del = el?.querySelector(".del");
          const edit = el?.querySelector(".edit");

          if (del) {
            del.addEventListener("click", () => {
              const all = loadData().filter((x, i) => i !== idx);
              saveData(all);
              showToast("削除しました");
              renderMarkers();
              map.closePopup();
            });
          }

          if (edit) {
            edit.addEventListener("click", () => {
              map.closePopup();
              const data = loadData();
              const rec = data[idx];
              if (!rec) return;
              const latlng = m.getLatLng();
              openEditFormAt(latlng, idx, rec); // 既存データ編集
            });
          }
        });

        currentMarkers[idx] = m;
      });

      if (currentData.length) {
        try {
          const bounds = L.featureGroup(
            currentData
              .filter((r) => Number.isFinite(r.lat) && Number.isFinite(r.lng))
              .map((r) => L.marker([r.lat, r.lng]))
          ).getBounds();
          if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
        } catch {}
      }
    }

    // ==== 新規／編集フォーム ====
    // idx === null -> 新規, それ以外 -> 編集
    function openEditFormAt(latlng, idx, preset = {}) {
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
      const isEdit = idx !== null && idx !== undefined;
      tempMarker = L.marker(latlng, { draggable: true }).addTo(map);

      const title = isEdit ? "神社メモを編集" : "ここに神社メモを追加";
      const saveLabel = isEdit ? "更新" : "保存";

      const formHtml =
        '<div class="popup">' +
        "<h3>" + title + "</h3>" +
        '<div class="form-row"><input id="f_name" type="text" ' +
        'placeholder="神社名（必須）" value="' + esc(preset.name || "") + '"></div>' +
        '<div class="form-row"><input id="f_addr" type="text" ' +
        'placeholder="住所（任意）" value="' + esc(preset.address || "") + '"></div>' +
        '<div class="form-row"><input id="f_url" type="text" ' +
        'placeholder="解説サイトURL（任意）" value="' + esc(preset.url || "") + '"></div>' +
        '<div class="form-row"><textarea id="f_desc" rows="4" ' +
        'placeholder="あなたの説明・考察（任意）">' +
        esc(preset.desc || "") + "</textarea></div>" +
        '<div class="form-actions">' +
        '<button id="f_cancel" class="btn">キャンセル</button>' +
        '<button id="f_save" class="btn">' + saveLabel + "</button>" +
        "</div>" +
        '<div class="hint">※ ピンはドラッグで微調整できます</div>' +
        "</div>";

      const pop = L.popup({
        maxWidth: 380,
        closeOnClick: false,
        closeButton: true,
      })
        .setLatLng(latlng)
        .setContent(formHtml)
        .openOn(map);

      setTimeout(() => {
        const fName = document.getElementById("f_name");
        const fAddr = document.getElementById("f_addr");
        const fUrl  = document.getElementById("f_url");
        const fDesc = document.getElementById("f_desc");
        const fCancel = document.getElementById("f_cancel");
        const fSave   = document.getElementById("f_save");

        fName && fName.focus();

        fCancel?.addEventListener("click", () => {
          if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
          }
          map.closePopup(pop);
        });

        fSave?.addEventListener("click", () => {
          const name = (fName?.value || "").trim();
          if (!name) {
            showToast("神社名を入力してください");
            return;
          }
          const addr = (fAddr?.value || "").trim();
          const url  = (fUrl?.value  || "").trim();
          const desc = (fDesc?.value || "").trim();
          const p = tempMarker?.getLatLng() || latlng;

          const cur = loadData();
          const rec = {
            name,
            address: addr,
            url,
            desc,
            lat: p.lat,
            lng: p.lng,
          };

          if (isEdit && cur[idx]) {
            cur[idx] = rec;   // 上書き
          } else {
            cur.push(rec);    // 新規
          }

          saveData(cur);
          showToast(isEdit ? "更新しました" : "保存しました");

          if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
          }
          map.closePopup(pop);
          renderMarkers();
        });
      }, 0);
    }

    // ==== 神社名 or 住所で検索してジャンプ ====
    function searchAndJump() {
      const kw = ($("searchKw").value || "").trim();
      if (!kw) {
        showToast("検索キーワードを入力してください");
        return;
      }
      if (!currentData.length) {
        showToast("ピンがまだありません");
        return;
      }

      const idx = currentData.findIndex((r) => {
        const n = (r.name || "").toString();
        const a = (r.address || "").toString();
        return n.includes(kw) || a.includes(kw);
      });

      if (idx === -1) {
        showToast("該当する神社が見つかりませんでした");
        return;
      }

      const m = currentMarkers[idx];
      if (!m) return;
      const latlng = m.getLatLng();
      map.setView(latlng, 17);
      m.openPopup();
    }

    // ==== 起動 ====
    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      renderMarkers();

      const toggleBtn = $("createToggle");
      toggleBtn.addEventListener("click", () => {
        createMode = !createMode;
        toggleBtn.classList.toggle("on", createMode);
        toggleBtn.textContent = createMode
          ? "作成モード ON"
          : "作成モード OFF";
        toggleBtn.setAttribute("aria-pressed", String(createMode));
        showToast(
          createMode
            ? "作成モード：地図をクリックしてピンを追加できます"
            : "作成モードを終了しました"
        );
      });

      $("btnSearch").addEventListener("click", searchAndJump);
      $("searchKw").addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchAndJump();
      });
    });
  </script>
</body>
</html>
