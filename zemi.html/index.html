<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>大垣市の神社マップ（BODIK API 1ファイル版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- MarkerCluster（任意。点が多いときの見やすさ向上） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    header {
      padding: .8rem 1rem;
      border-bottom: 1px solid #ddd;
      display: flex; gap: .75rem; align-items: center; flex-wrap: wrap;
    }
    header h1 { font-size: 1rem; margin: 0; }
    header .meta { font-size: .85rem; opacity: .8; }
    #map { height: calc(100vh - 64px); }
    .popup h3 { margin: 0 0 .3rem; font-size: 1rem; line-height: 1.2; }
    .popup p { margin: .2rem 0; font-size: .9rem; }
    .legend {
      position: absolute; z-index: 1000; right: 10px; top: 74px;
      background: rgba(255,255,255,.9); padding: .5rem .6rem; border-radius: .5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.1); font-size: .85rem;
    }
    .badge { display: inline-block; padding: .15rem .4rem; border-radius: .4rem; border: 1px solid #ccc; font-size: .75rem; }
    .controls { margin-left: auto; display:flex; gap:.5rem; flex-wrap: wrap; }
    .controls input, .controls select, .controls button {
      font-size: .9rem; padding: .35rem .5rem; border-radius: .45rem; border: 1px solid #ccc; background: transparent;
    }
    .controls button { cursor: pointer; }
    .toast {
      position: absolute; z-index: 1100; left: 50%; transform: translateX(-50%);
      bottom: 12px; background: rgba(0,0,0,.7); color: #fff; padding: .5rem .75rem; border-radius: .5rem; font-size: .85rem;
    }
    .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; clip-path: inset(50%); }
  </style>
</head>
<body>
  <header>
    <h1>大垣市の神社マップ</h1>
    <span class="meta">データ出典：BODIK WAPI（tourism / cultural_property）</span>
    <div class="controls" role="group" aria-label="操作">
      <input id="kw" type="text" placeholder="名称で絞り込み（例：八幡）" />
      <select id="sourceSel" title="データソース">
        <option value="all">すべて（tourism + cultural_property）</option>
        <option value="tourism">tourism のみ</option>
        <option value="cultural_property">cultural_property のみ</option>
      </select>
      <button id="reloadBtn">再読込</button>
    </div>
  </header>

  <div id="map" role="region" aria-label="地図"></div>
  <div class="legend">
    <div><span class="badge">神社</span> を表示しています（分類／名称に「神社」を含むデータ）。</div>
    <div style="margin-top:.25rem;">リンクが無い場合は観光ポータル検索に誘導します。</div>
  </div>
  <div id="toast" class="toast" style="display:none;"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // ======== 設定値 ========
    const CITY_NAME = "大垣市";
    const MAX_RESULTS = 2000; // 充分大きめに
    const WAPI_BASE = "https://wapi.bodik.jp";
    const OGAKI_PORTAL_SEARCH = (name) => `https://www.ogakikanko.jp/?s=${encodeURIComponent(name || "")}`;

    // 神社判定に使うキーワード（分類・カテゴリ・名称でチェック）
    const JINJA_KEYS = ["神社", "神社・仏閣", "寺社", "宗教施設"];

    // ======== ユーティリティ ========
    const showToast = (msg, ms=2200) => {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(() => el.style.display = "none", ms);
    };

    // 値取得（列名ゆらぎに対応）
    const pick = (obj, keys) => {
      for (const k of keys) {
        if (obj?.[k] != null && obj[k] !== "") return obj[k];
      }
      return undefined;
    };

    const toNumber = (v) => {
      const n = (typeof v === "string") ? v.replace(/[^\d\.\-]/g, "") : v;
      const f = parseFloat(n);
      return Number.isFinite(f) ? f : undefined;
    };

    const looksLikeJinja = (rec) => {
      const name = (pick(rec, ["名称","施設名","name","title"]) || "").toString();
      const cat  = (pick(rec, ["分類","カテゴリ","ジャンル","category","genre","種別"]) || "").toString();

      const inCat  = JINJA_KEYS.some(k => cat.includes(k));
      const inName = name.includes("神社");
      return inCat || inName;
    };

    // 座標抽出（緯度・経度 or latitude/longitude or Y/X など）
    const extractLatLng = (rec) => {
      let lat = toNumber(pick(rec, ["緯度","latitude","lat","Lat","LAT","Y","y","ｙ"]));
      let lng = toNumber(pick(rec, ["経度","longitude","lon","lng","Long","LON","X","x","ｘ"]));
      // 一部データは X=経度, Y=緯度 の順で入っている想定
      if (lat === undefined && lng !== undefined) {
        // 稀な誤列対処はしない（確定できないため）
      }
      return (Number.isFinite(lat) && Number.isFinite(lng)) ? [lat, lng] : undefined;
    };

    const getName = (rec) => pick(rec, ["名称","施設名","name","title"]) || "(名称未設定)";
    const getUrl  = (rec) => pick(rec, ["説明URL","URL","url","link","website","Webサイト"]) || OGAKI_PORTAL_SEARCH(getName(rec));
    const getAddr = (rec) => pick(rec, ["住所","所在地","address"]) || "";

    // 重複排除キー（名称＋座標で十分）
    const makeKey = (rec) => {
      const n = getName(rec);
      const ll = extractLatLng(rec);
      return `${n}::${ll ? ll.join(",") : "no-ll"}`;
    };

    // ======== データ取得（WAPI） ========
    async function fetchWapi(apiname, params) {
      const url = new URL(`${WAPI_BASE}/${apiname}`);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error(`WAPI fetch failed: ${res.status}`);
      return res.json();
    }

    // tourism（観光施設）を取得（大垣×最大件数）
    async function loadTourism() {
      const data = await fetchWapi("tourism", {
        select_type: "data",
        municipalityName: CITY_NAME,
        maxResults: String(MAX_RESULTS)
      });
      // 返却仕様はapinameにより異なり得るので records 的な配列を総当たり
      const rows = Array.isArray(data) ? data
                 : Array.isArray(data?.records) ? data.records
                 : Array.isArray(data?.data) ? data.data
                 : Array.isArray(data?.result) ? data.result
                 : [];
      return rows.filter(looksLikeJinja);
    }

    // cultural_property（文化財）で神社に該当しそうなものも補完
    async function loadCulturalProperty() {
      const data = await fetchWapi("cultural_property", {
        select_type: "data",
        municipalityName: CITY_NAME,
        maxResults: String(MAX_RESULTS)
      });
      const rows = Array.isArray(data) ? data
                 : Array.isArray(data?.records) ? data.records
                 : Array.isArray(data?.data) ? data.data
                 : Array.isArray(data?.result) ? data.result
                 : [];
      return rows.filter(looksLikeJinja);
    }

    // ======== 地図描画 ========
    let map, cluster;
    function initMap() {
      map = L.map("map", { zoomControl: true }).setView([35.366, 136.616], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
      cluster = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
      map.addLayer(cluster);
    }

    function clearMarkers() {
      cluster?.clearLayers();
    }

    function addMarkers(records) {
      let count = 0;
      records.forEach(rec => {
        const latlng = extractLatLng(rec);
        if (!latlng) return;
        const name = getName(rec);
        const url  = getUrl(rec);
        const addr = getAddr(rec);

        const html = `
          <div class="popup">
            <h3>${name}</h3>
            ${addr ? `<p>${addr}</p>` : ""}
            <p><a href="${url}" target="_blank" rel="noopener">解説ページを開く</a></p>
          </div>
        `;
        const marker = L.marker(latlng).bindPopup(html, { maxWidth: 320 });
        cluster.addLayer(marker);
        count++;
      });
      if (count > 0) {
        showToast(`${count}件の神社を表示しました`);
        try {
          const bounds = cluster.getBounds();
          if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
        } catch {}
      } else {
        showToast("該当データが見つかりませんでした（分類名や座標列が合っているかご確認ください）", 3200);
      }
    }

    // ======== メイン処理 ========
    async function reloadData() {
      clearMarkers();
      showToast("データ読込中…");
      const sourceSel = document.getElementById("sourceSel").value;
      const kw = (document.getElementById("kw").value || "").trim();

      try {
        // ソース別に取得
        const loaders = [];
        if (sourceSel === "tourism" || sourceSel === "all") loaders.push(loadTourism());
        if (sourceSel === "cultural_property" || sourceSel === "all") loaders.push(loadCulturalProperty());

        const results = (await Promise.allSettled(loaders))
          .flatMap(r => r.status === "fulfilled" ? r.value : []);

        // フィルタ（重複排除＋キーワード）
        const dedup = new Map();
        for (const rec of results) {
          if (kw) {
            const name = getName(rec);
            if (!name.includes(kw)) continue;
          }
          const key = makeKey(rec);
          if (!dedup.has(key)) dedup.set(key, rec);
        }

        const finalRows = Array.from(dedup.values());
        addMarkers(finalRows);
      } catch (e) {
        console.error(e);
        showToast("読込に失敗しました（コンソールを確認してください）", 3500);
      }
    }

    // 初期化
    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      document.getElementById("reloadBtn").addEventListener("click", reloadData);
      document.getElementById("sourceSel").addEventListener("change", reloadData);
      document.getElementById("kw").addEventListener("keydown", (e) => {
        if (e.key === "Enter") reloadData();
      });
      // 初回ロード
      reloadData();
    });
  </script>
</body>
</html>
