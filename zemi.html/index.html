<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>大垣市 神社マップ（管理用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
        "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #ffffff;
      color: #111111;
    }
    header {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #e5e5e5;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.6rem;
      align-items: center;
      background: #f8f8f8;
    }
    header h1 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #111;
    }
    .ctl {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }
    input[type="text"] {
      font-size: 0.9rem;
      padding: 0.38rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #aaa;
      color: #111;
    }
    .btn {
      font-size: 0.9rem;
      padding: 0.38rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid #777;
      background: #f2f2f2;
      cursor: pointer;
      color: #111;
    }
    .btn.on {
      background: #16a34a33;
      border-color: #16a34a;
    }
    #map {
      height: calc(100vh - 60px);
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      background: rgba(0, 0, 0, 0.78);
      color: #fff;
      padding: 0.5rem 0.8rem;
      border-radius: 0.5rem;
      font-size: 0.82rem;
      display: none;
      z-index: 1000;
    }
    .popup {
      color: #111111 !important;
      font-size: 0.9rem;
    }
    .popup h3 {
      margin: 0 0 0.3rem;
      font-size: 1.1rem;
      color: #000;
    }
    .popup a {
      color: #0645ad;
      text-decoration: underline;
    }
    .desc {
      white-space: pre-wrap;
      color: #111;
      line-height: 1.35;
    }
    .hint {
      color: #555;
      font-size: 0.8rem;
    }
    .form-row input,
    .form-row textarea {
      border: 1px solid #777;
      color: #111;
      background: #fafafa;
    }
    .form-actions .btn {
      background: #e5e5e5;
      border-color: #555;
      color: #111;
    }
    .edit { color: #1d4ed8; }
    .del { color: #b91c1c; }
    .leaflet-popup-content {
      max-height: 260px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>大垣市 神社マップ（管理用）</h1>
    <div class="ctl">
      <input id="searchKw" type="text" placeholder="神社名 or 住所で検索" />
      <button id="btnSearch" class="btn">検索してジャンプ</button>
      <button id="createToggle"
              class="btn"
              aria-pressed="false">
        作成モード OFF
      </button>
    </div>
  </header>

  <div id="map"></div>
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ---- 省略なし完全版（編集・削除・作成モード実装済） ---- */
    const $ = (id) => document.getElementById(id);
    const LS_KEY = "ogaki_shrines_v1";

    const showToast = (msg, ms = 2200) => {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => (t.style.display = "none"), ms);
    };

    const saveData = (arr) =>
      localStorage.setItem(LS_KEY, JSON.stringify(arr || []));
    const loadData = () => JSON.parse(localStorage.getItem(LS_KEY) || "[]");

    const esc = (s) =>
      String(s ?? "").replace(/[&<>"']/g, (c) =>
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
      );

    let map, createMode = false, tempMarker = null;
    let markerLayer, currentData = [], currentMarkers = [];

    function initMap() {
      map = L.map("map").setView([35.366, 136.62], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
        .addTo(map);

      markerLayer = L.layerGroup().addTo(map);

      map.on("click", (e) => {
        if (!createMode) return;
        openEditFormAt(e.latlng, null);
      });
    }

    function buildPopupHtml(r, idx) {
      const name = esc(r.name);
      const url  = esc(r.url);
      const addr = esc(r.address);
      const desc = esc(r.desc);
      return `
        <div class="popup">
          <h3>${name}</h3>
          ${addr ? `<p>${addr}</p>` : ""}
          ${url ? `<p><a href="${url}" target="_blank">解説ページを開く</a></p>` : ""}
          ${desc ? `<div class="desc">${desc}</div>` :
            `<div class="hint">（説明は未入力）</div>`}
          <div class="hint">
            <a class="edit" data-idx="${idx}">編集</a> /
            <a class="del" data-idx="${idx}">削除</a>
          </div>
        </div>`;
    }

    function renderMarkers() {
      markerLayer.clearLayers();
      currentData = loadData();
      currentMarkers = [];

      currentData.forEach((r, idx) => {
        const m = L.marker([r.lat, r.lng]).addTo(markerLayer);
        m.bindPopup(buildPopupHtml(r, idx));
        currentMarkers[idx] = m;

        m.on("popupopen", (ev) => {
          const el = ev.popup.getElement();
          el.querySelector(".edit").onclick = () => {
            map.closePopup();
            openEditFormAt(m.getLatLng(), idx, r);
          };
          el.querySelector(".del").onclick = () => {
            const d = loadData().filter((_, i) => i !== idx);
            saveData(d);
            showToast("削除しました");
            renderMarkers();
            map.closePopup();
          };
        });
      });
    }

    function openEditFormAt(latlng, idx, preset = {}) {
      if (tempMarker) map.removeLayer(tempMarker);
      tempMarker = L.marker(latlng, { draggable: true }).addTo(map);

      const isEdit = idx !== null;
      const title = isEdit ? "編集" : "追加";
      const saveLabel = isEdit ? "更新" : "保存";

      const formHtml = `
        <div class="popup">
          <h3>${title}</h3>
          <div class="form-row">
            <input id="f_name" type="text" placeholder="神社名（必須）"
              value="${esc(preset.name || "")}">
          </div>
          <div class="form-row">
            <input id="f_addr" type="text" placeholder="住所（任意）"
              value="${esc(preset.address || "")}">
          </div>
          <div class="form-row">
            <input id="f_url" type="text" placeholder="解説URL（任意）"
              value="${esc(preset.url || "")}">
          </div>
          <div class="form-row">
            <textarea id="f_desc" rows="3"
              placeholder="説明（任意）">${esc(preset.desc || "")}</textarea>
          </div>
          <div class="form-actions">
            <button id="f_cancel" class="btn">キャンセル</button>
            <button id="f_save" class="btn">${saveLabel}</button>
          </div>
          <div class="hint">※ ピンはドラッグで調整できます</div>
        </div>`;

      const pop = L.popup({ maxWidth: 380 })
        .setLatLng(latlng).setContent(formHtml).openOn(map);

      setTimeout(() => {
        $("f_cancel").onclick = () => {
          map.removeLayer(tempMarker);
          tempMarker = null;
          map.closePopup(pop);
        };
        $("f_save").onclick = () => {
          const name = $("f_name").value.trim();
          if (!name) {
            showToast("神社名を入力してください");
            return;
          }
          const addr = $("f_addr").value.trim();
          const url = $("f_url").value.trim();
          const desc = $("f_desc").value.trim();
          const p = tempMarker.getLatLng();

          const dat = loadData();
          const rec = { name, address: addr, url, desc, lat: p.lat, lng: p.lng };

          if (isEdit) dat[idx] = rec;
          else dat.push(rec);

          saveData(dat);
          map.closePopup(pop);
          map.removeLayer(tempMarker);
          tempMarker = null;
          renderMarkers();
          showToast(isEdit ? "更新しました" : "保存しました");
        };
      });
    }

    function searchAndJump() {
      const kw = $("searchKw").value.trim();
      if (!kw) return showToast("検索ワードなし");

      const idx = currentData.findIndex(r =>
        (r.name || "").includes(kw) || (r.address || "").includes(kw)
      );
      if (idx === -1) return showToast("見つかりません");

      const m = currentMarkers[idx];
      map.setView(m.getLatLng(), 17);
      m.openPopup();
    }

    window.onload = () => {
      initMap();
      renderMarkers();
      $("btnSearch").onclick = searchAndJump;
      $("searchKw").onkeydown = (e) =>
        e.key === "Enter" && searchAndJump();
      $("createToggle").onclick = () => {
        createMode = !createMode;
        $("createToggle").textContent =
          createMode ? "作成モード ON" : "作成モード OFF";
      };
    };
  </script>
</body>
</html>
