<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>大垣市 神社マップ（閲覧用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
        "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    header {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #e5e5e5;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.6rem;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    .ctl {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }
    input[type="text"] {
      font-size: 0.9rem;
      padding: 0.38rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
      background: transparent;
    }
    .btn {
      font-size: 0.9rem;
      padding: 0.38rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
      background: transparent;
      cursor: pointer;
    }
    #map {
      height: calc(100vh - 60px);
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      background: rgba(0, 0, 0, 0.78);
      color: #fff;
      padding: 0.5rem 0.8rem;
      border-radius: 0.5rem;
      font-size: 0.82rem;
      display: none;
      z-index: 1000;
    }
    .popup h3 {
      margin: 0 0 0.3rem;
      font-size: 1rem;
    }
    .popup p {
      margin: 0.25rem 0;
    }
    .desc {
      white-space: pre-wrap;
    }
    .hint {
      font-size: 0.8rem;
      opacity: 0.75;
    }
    @media (prefers-color-scheme: dark) {
      .popup { color: #e9eaed; }
    }
  </style>
</head>
<body>
  <header>
    <h1>大垣市 神社マップ（閲覧用）</h1>
    <div class="ctl">
      <input id="searchKw" type="text" placeholder="神社名 or 住所で検索" />
      <button id="btnSearch" class="btn">検索してジャンプ</button>
    </div>
  </header>

  <div id="map"></div>
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const showToast = (msg, ms = 2200) => {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => (t.style.display = "none"), ms);
    };
    const esc = (s) =>
      String(s ?? "").replace(/[&<>"']/g, (c) =>
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
      );

    const LS_KEY = "ogaki_shrines_v1";
    const loadData = () => {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      } catch {
        return [];
      }
    };

    let map, markerLayer;
    let currentData = [];
    let currentMarkers = [];

    function initMap() {
      map = L.map("map").setView([35.366, 136.62], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);
    }

    function buildPopupHtml(r) {
      const name = esc(r.name || "(名称未設定)");
      const addr = esc(r.address || "");
      const url = esc(r.url || "");
      const desc = esc(r.desc || "");
      const descBlock = desc
        ? '<div class="desc">' + desc + "</div>"
        : '<div class="hint">（説明は未入力）</div>';
      const urlBlock = url
        ? '<p><a href="' +
          url +
          '" target="_blank" rel="noopener">解説ページを開く</a></p>'
        : "";
      return (
        '<div class="popup">' +
        "<h3>" +
        name +
        "</h3>" +
        (addr ? "<p>" + addr + "</p>" : "") +
        urlBlock +
        descBlock +
        "</div>"
      );
    }

    function renderMarkers() {
      markerLayer.clearLayers();
      currentData = loadData();
      currentMarkers = [];

      currentData.forEach((r, idx) => {
        if (!Number.isFinite(r.lat) || !Number.isFinite(r.lng)) return;
        const m = L.marker([r.lat, r.lng]).addTo(markerLayer);
        m.bindPopup(buildPopupHtml(r), { maxWidth: 360 });
        currentMarkers[idx] = m;
      });

      if (currentData.length) {
        try {
          const bounds = L.featureGroup(
            currentData
              .filter((r) => Number.isFinite(r.lat) && Number.isFinite(r.lng))
              .map((r) => L.marker([r.lat, r.lng]))
          ).getBounds();
          if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
        } catch {}
      }
    }

    function searchAndJump() {
      const kw = ($("searchKw").value || "").trim();
      if (!kw) {
        showToast("検索キーワードを入力してください");
        return;
      }
      if (!currentData.length) {
        showToast("ピンがまだありません");
        return;
      }

      const idx = currentData.findIndex((r) => {
        const n = (r.name || "").toString();
        const a = (r.address || "").toString();
        return n.includes(kw) || a.includes(kw);
      });

      if (idx === -1) {
        showToast("該当する神社が見つかりませんでした");
        return;
      }

      const m = currentMarkers[idx];
      if (!m) return;
      const latlng = m.getLatLng();
      map.setView(latlng, 17);
      m.openPopup();
    }

    window.addEventListener("DOMContentLoaded", () => {
      initMap();
      renderMarkers();

      $("btnSearch").addEventListener("click", searchAndJump);
      $("searchKw").addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchAndJump();
      });
    });
  </script>
</body>
</html>
